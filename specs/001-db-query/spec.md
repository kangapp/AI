# Feature Specification: Database Query Tool

**Feature Branch**: `001-db-query`
**Created**: 2026-01-07
**Status**: Draft
**Input**: User description: "这是一个数据库查询工具，用户可以添加一个 db url，系统会连接到数据库，获取数据库的 metadta，然后将数据库中的 table 和 view 的信息展示出来，然后用户可以自己输入 sql 查询，也可以通过自然语言来生成 sql 查询。基本想法：数据库连接字符串和数据库的 metadata 都会存储到 sqlite 数据库中。我们可以根据 mysql 的功能来查询系统中的表和视图的信息，然后用 LLM 来将这些信息转换成 json 格式，然后存储到 sqlite 数据库中。这个信息以后可以复用。当用户使用 LLM 来生成 sql 查询时，我们可以把系统中的表和视图的信息作为 context 传递给 LLM，然后 LLM 会根据这些信息来生成 sql 查询。任何输入的 sql 语句，都需要经过 sqlparser 解析，确保语法正确，并且仅包含 select 语句。如果语法不正确，需要给出错误信息。如果查询不包含 limit 子句，则默认添加 limit 1000 子句。输出格式是 json，前端将其组织成表格，并显示出来。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 数据库连接管理 (Priority: P1)

用户可以添加数据库连接字符串，系统连接到数据库并自动获取元数据（表和视图的结构信息），然后将这些信息展示给用户。

**Why this priority**: 这是整个工具的基础功能，没有数据库连接就无法进行任何查询操作。

**Independent Test**: 可以通过添加一个测试数据库连接，验证系统能否成功连接、获取元数据并展示表和视图信息来完成测试。

**Acceptance Scenarios**:

1. **Given** 用户没有添加任何数据库连接，**When** 用户输入一个有效的数据库连接字符串，**Then** 系统成功连接到数据库并获取表和视图的元数据
2. **Given** 用户输入了无效的数据库连接字符串，**When** 用户提交连接请求，**Then** 系统显示清晰的错误信息，说明连接失败的原因
3. **Given** 用户已经添加了数据库连接，**When** 用户查看该数据库的详情，**Then** 系统展示所有表和视图的列表及其结构信息（列名、数据类型等）
4. **Given** 用户添加了多个数据库连接，**When** 用户浏览数据库列表，**Then** 系统显示所有已添加的数据库，并允许用户切换查看

---

### User Story 2 - SQL 查询执行 (Priority: P2)

用户可以直接输入 SQL 查询语句，系统验证语法后执行查询，并以表格形式展示结果。

**Why this priority**: 这是核心查询功能，允许熟悉 SQL 的用户快速获取数据。依赖于数据库连接功能。

**Independent Test**: 可以通过连接到测试数据库，输入各种 SQL 查询语句，验证系统能否正确解析、执行并返回结果。

**Acceptance Scenarios**:

1. **Given** 用户已连接到数据库，**When** 用户输入一个语法正确的 SELECT 查询，**Then** 系统执行查询并以表格形式展示结果
2. **Given** 用户输入了包含语法错误的 SQL 查询，**When** 用户提交查询，**Then** 系统显示具体的语法错误位置和原因
3. **Given** 用户输入了非 SELECT 语句（如 UPDATE、DELETE、DROP 等），**When** 用户提交查询，**Then** 系统拒绝执行并显示错误信息，说明只允许 SELECT 查询
4. **Given** 用户输入的查询没有 LIMIT 子句，**When** 系统执行查询，**Then** 系统自动添加 LIMIT 1000 并告知用户
5. **Given** 查询返回大量数据，**When** 结果展示，**Then** 系统以分页或虚拟滚动方式展示，避免页面卡顿
6. **Given** 查询执行时间较长，**When** 用户等待结果，**Then** 系统显示加载状态，如果超时则提供取消选项

---

### User Story 3 - 自然语言查询生成 (Priority: P3)

用户可以用自然语言描述想要查询的数据，系统根据数据库元数据生成对应的 SQL 查询，然后执行并展示结果。

**Why this priority**: 这是增强功能，让不熟悉 SQL 的用户也能查询数据。依赖于数据库元数据和 LLM 集成。

**Independent Test**: 可以通过输入各种自然语言查询描述，验证系统能否生成正确的 SQL 并返回预期结果。

**Acceptance Scenarios**:

1. **Given** 用户已连接到数据库，**When** 用户输入自然语言查询描述（如"显示所有订单金额大于1000的记录"），**Then** 系统生成对应的 SQL 查询并展示给用户确认
2. **Given** 系统生成了 SQL 查询，**When** 用户确认执行，**Then** 系统执行查询并以表格形式展示结果
3. **Given** 用户的自然语言描述不清晰，**When** 系统尝试生成 SQL，**Then** 系统询问用户澄清或提供多个可能的查询选项
4. **Given** 数据库有多个表和关联关系，**When** 用户输入涉及多表的查询，**Then** 系统能够生成正确的 JOIN 查询
5. **Given** 生成的 SQL 查询有语法错误或执行失败，**When** 系统检测到错误，**Then** 系统显示错误信息并提供修改建议

---

### Edge Cases

- **数据库连接中断**：查询执行过程中数据库连接断开，系统应显示连接错误并允许用户重新连接
- **超大结果集**：即使有 LIMIT 1000，某些查询仍可能返回大量数据或宽表（很多列），系统需要处理性能问题
- **特殊字符和编码**：数据库中的数据可能包含特殊字符、Emoji 或非 ASCII 字符，系统应正确处理和显示
- **并发查询**：用户同时提交多个查询，系统应管理查询队列或提供并发控制
- **元数据变更**：数据库结构在连接后发生变化（如表被删除或修改），系统应能检测并更新缓存的元数据
- **LLM 服务不可用**：自然语言转 SQL 功能依赖 LLM 服务，如果服务不可用，系统应优雅降级并提示用户
- **SQL 注入尝试**：即使用户只能执行 SELECT，仍可能有恶意输入，系统应验证和清理所有输入
- **不同数据库方言**：不同数据库（MySQL、PostgreSQL、SQLite 等）的 SQL 语法有差异，系统应适配主流数据库

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 允许用户添加数据库连接字符串并测试连接
- **FR-002**: 系统 MUST 在连接成功后自动获取数据库的所有表和视图的元数据信息
- **FR-003**: 系统 MUST 将数据库连接信息和元数据持久化存储，供后续使用
- **FR-004**: 系统 MUST 展示数据库中的表和视图列表，包括列名、数据类型、约束等结构信息
- **FR-005**: 系统 MUST 接受用户输入的 SQL 查询语句并使用解析器验证语法
- **FR-006**: 系统 MUST 只允许执行 SELECT 查询，拒绝任何其他类型的 SQL 语句（INSERT、UPDATE、DELETE、DROP、ALTER 等）
- **FR-007**: 系统 MUST 在查询不包含 LIMIT 子句时自动添加 LIMIT 1000，并告知用户
- **FR-008**: 系统 MUST 以结构化格式返回查询结果，支持前端以表格形式展示
- **FR-009**: 系统 MUST 提供清晰的 SQL 语法错误信息，包括错误位置和原因
- **FR-010**: 系统 MUST 允许用户输入自然语言查询描述，并基于数据库元数据生成 SQL 查询
- **FR-011**: 系统 MUST 在生成 SQL 后展示给用户确认，用户可以修改后再执行
- **FR-012**: 系统 MUST 支持多种数据库类型（至少支持 MySQL、PostgreSQL、SQLite）
- **FR-013**: 系统 MUST 管理多个数据库连接，允许用户切换和删除
- **FR-014**: 系统 MUST 在数据库元数据变化时能检测并更新缓存
- **FR-015**: 系统 MUST 处理查询执行超时，提供取消选项和超时配置
- **FR-016**: 系统 MUST 对所有用户输入进行验证，防止恶意输入
- **FR-017**: 系统 MUST 提供查询历史记录，用户可以查看和重用之前的查询
- **FR-018**: 系统 MUST 支持导出查询结果为常用格式（CSV、JSON 等）

### Key Entities

- **数据库连接 (Database Connection)**: 表示一个已配置的数据库连接，包含连接字符串、连接名称、数据库类型、创建时间、最后连接时间等属性

- **表元数据 (Table Metadata)**: 表示数据库中一个表的结构信息，包含表名、列列表（列名、数据类型、是否可空、默认值、约束等）、索引信息、注释等

- **视图元数据 (View Metadata)**: 表示数据库中一个视图的结构信息，包含视图名、列列表、定义语句（如果可获取）、注释等

- **查询 (Query)**: 表示用户执行的一次查询，包含查询类型（SQL 或自然语言）、查询内容、生成的 SQL（如果是自然语言）、执行时间、结果行数、状态（成功/失败）、错误信息（如果失败）等

- **查询结果 (Query Result)**: 表示一次查询执行返回的数据，包含列定义和数据行，支持分页和格式化输出

## Assumptions

- 用户拥有数据库的读取权限，但不应该有修改数据的权限（系统层面拒绝非 SELECT 查询）
- 数据库支持标准的 SQL 信息模式（Information Schema）或等效的元数据查询方式
- LLM 服务能够理解和生成目标数据库的 SQL 方言
- 用户主要通过 Web 浏览器访问该工具
- 每次查询的默认结果限制（1000 行）足以满足大多数使用场景
- 用户具有一定的技术背景，至少了解基本的数据库概念

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在 30 秒内完成添加新数据库连接并看到表和视图列表
- **SC-002**: 95% 的语法正确的 SQL 查询能够在 2 秒内完成验证和执行（数据量在限制范围内）
- **SC-003**: 90% 的 SQL 语法错误能够被准确识别并提供有用的错误信息
- **SC-004**: 系统能够正确识别并拒绝 100% 的非 SELECT 查询
- **SC-005**: 80% 的自然语言查询能够生成可执行的 SQL 查询（基于常见查询模式）
- **SC-006**: 系统支持至少 3 种主流数据库类型（MySQL、PostgreSQL、SQLite）
- **SC-007**: 单个用户可以同时管理至少 10 个不同的数据库连接
- **SC-008**: 查询结果的展示（包括 1000 行数据）在前端渲染时间不超过 1 秒
- **SC-009**: 系统能够处理包含最多 50 列的宽表查询结果
- **SC-010**: 用户能够在不需要培训的情况下，在首次使用时成功完成一次查询
